<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç„¡ç—›å­˜éŒ¢æ³• | æ™ºæ…§é ç®—ç®¡å®¶</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chosen Palette: Warm Sand & Sage -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #FAF9F6; color: #44403C; scroll-behavior: smooth; }
        .chart-container { position: relative; width: 100%; max-width: 450px; margin: 0 auto; height: 280px; max-height: 320px; cursor: pointer; }
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.02); transition: all 0.3s ease; }
        .card:hover { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.02); }
        .input-std { border: 1px solid #E7E5E4; border-radius: 8px; padding: 0.5rem; width: 100%; outline: none; transition: border-color 0.2s; }
        .input-std:focus { border-color: #D4A373; box-shadow: 0 0 0 2px rgba(212, 163, 115, 0.2); }
        /* Custom Scrollbar */
        .scroller::-webkit-scrollbar { width: 6px; }
        .scroller::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
        .scroller::-webkit-scrollbar-thumb { background: #D6D3D1; border-radius: 3px; }
        
        /* Hide arrows from number inputs */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        #loadingOverlay { backdrop-filter: blur(4px); }
        
        /* Tab Transitions */
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen relative">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-stone-100 bg-opacity-80 z-[100] flex flex-col items-center justify-center transition-opacity duration-300">
        <div class="w-12 h-12 border-4 border-[#D4A373] border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 text-stone-600 font-bold tracking-wide">ç³»çµ±è¼‰å…¥ä¸­...</p>
    </div>

    <!-- Unified Custom Dialog Modal -->
    <div id="dialogModal" class="hidden fixed inset-0 bg-stone-900 bg-opacity-60 flex items-center justify-center z-[200] p-4 transition-opacity">
        <div class="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl transform transition-transform scale-95" id="dialogModalContent">
            <h3 class="font-bold text-xl mb-3 text-stone-800 flex items-center gap-2" id="dialogTitle">æç¤º</h3>
            <p class="text-sm text-stone-600 mb-6 leading-relaxed" id="dialogMessage">è¨Šæ¯å…§å®¹</p>
            <div class="flex justify-end gap-3" id="dialogButtons"></div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto space-y-6">
        
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-2xl shadow-sm gap-4">
            <div>
                <h1 class="text-3xl font-bold text-stone-700 tracking-tight">ç„¡ç—›å­˜éŒ¢æ³•ç®¡å®¶</h1>
                <p class="text-stone-500 mt-1">å®Œç¾é€£å‹•çµé¤˜ï¼Œç›®æ¨™çœ‹å¾—åˆ°é€²åº¦çš„é ç®—ç³»çµ±</p>
            </div>
            <div class="flex items-center gap-4 text-right">
                <button onclick="app.openHistoryModal()" class="px-4 py-2 bg-stone-100 hover:bg-stone-200 text-stone-700 font-bold rounded-lg transition shadow-sm border border-stone-200 flex items-center gap-2">
                    ğŸ•°ï¸ æŸ¥çœ‹æ­·å²ç´€éŒ„
                </button>
                <div>
                    <div class="text-sm text-stone-400">ç•¶å‰æœˆä»½</div>
                    <div class="text-2xl font-medium text-[#D4A373]" id="currentDateDisplay">--</div>
                </div>
            </div>
        </header>

        <!-- User Instructions (Collapsible) -->
        <section class="bg-stone-50 border border-stone-200 rounded-2xl p-5 shadow-sm">
            <button onclick="document.getElementById('instructionsBody').classList.toggle('hidden')" class="w-full flex justify-between items-center text-stone-700 font-bold text-lg focus:outline-none">
                <span class="flex items-center gap-2">ğŸ’¡ ç³»çµ±ä½¿ç”¨æŒ‡å—èˆ‡å¸¸è¦‹å•ç­” (é»æ“Šå±•é–‹)</span>
                <span class="text-stone-400 text-xs border border-stone-300 px-3 py-1 rounded-full hover:bg-stone-100 transition">å±•é–‹ / æ”¶åˆ</span>
            </button>
            <div id="instructionsBody" class="mt-4 text-sm text-stone-600 space-y-4 leading-relaxed border-t border-stone-200 pt-4 hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-bold text-[#D4A373] mb-1">Q1: å„€è¡¨æ¿å¯ä»¥è‡ªè¨‚æ¯”ä¾‹å—ï¼Ÿ</h4>
                        <p>å¯ä»¥ï¼ç¾åœ¨æ‚¨å¯ä»¥ç›´æ¥åœ¨ã€Œè³‡é‡‘åˆ†é…å„€è¡¨æ¿ã€ä¸­æ‰‹å‹•ä¿®æ”¹ä¸‰å¤§å¸³æœ¬çš„ % æ•¸æˆ–é‡‘é¡ã€‚ä¿®æ”¹å¾Œï¼Œä¸‹æ–¹å°æ‡‰çš„å¸³æœ¬é ç®—ä¹Ÿæœƒè‡ªå‹•åŒæ­¥æ›´æ–°åŸºæº–ï¼</p>
                    </div>
                    <div>
                        <h4 class="font-bold text-[#D4A373] mb-1">Q2: å­˜éŒ¢ç›®æ¨™çš„ã€Œå·²ç´¯ç©ã€æœƒå»¶çºŒå—ï¼Ÿ</h4>
                        <p>æœƒçš„ï¼ç•¶æ‚¨é»æ“Šã€ŒåŸ·è¡Œæœˆçµç®—ã€æ™‚ï¼Œç›®æ¨™ä¸­ã€Œæœ¬æœˆåˆ†é…ã€çš„é‡‘é¡æœƒè¢«æ­£å¼å­˜å…¥ã€Œå·²ç´¯ç©ã€ä¸­ï¼Œä¸‹å€‹æœˆçš„åˆ†é…é¡æœƒæ­¸é›¶ï¼Œä½†æ‚¨çš„ç¸½å­˜æ¬¾æœƒæŒçºŒæˆé•·ï¼Œé€²åº¦æ¢ä¸æœƒå€’é€€ã€‚</p>
                    </div>
                    <div>
                        <h4 class="font-bold text-[#D4A373] mb-1">Q3: ã€Œæœªåˆ†é…çµé¤˜æ°´åº«ã€æ€éº¼ç”¨ï¼Ÿ</h4>
                        <p>æœˆåº•çµç®—æ™‚ï¼Œæ‰€æœ‰å¸³æœ¬ä¸­<strong>æ²’åˆ†é…å®Œã€æ²’èŠ±å®Œçš„éŒ¢</strong>éƒ½æœƒæµé€²é€™è£¡ã€‚å¦‚æœæ‚¨æƒ³å¹«æŸå€‹ç›®æ¨™ã€ŒåŠ ç¢¼ã€ï¼Œåªè¦æ‰‹å‹•ä¿®æ”¹è©²ç›®æ¨™çš„ã€Œå·²ç´¯ç©é‡‘é¡ã€ï¼Œç³»çµ±å°±æœƒè‡ªå‹•å¾æ°´åº«æ‰£æ¬¾ï¼</p>
                    </div>
                    <div>
                        <h4 class="font-bold text-[#D4A373] mb-1">Q4: ä¿¡ç”¨å¡è¢‹çš„éŒ¢ä»€éº¼æ™‚å€™æ­¸é›¶ï¼Ÿ</h4>
                        <p>ç•¶æ‚¨åœ¨ç¾å¯¦ä¸­ç¹³äº¤äº†ä¿¡ç”¨å¡è²»å¾Œï¼Œé»æ“Šå¡è²»æ§ç®¡å€çš„ã€Œâœ… å·²ç¹³æ¸…å¡è²»ã€æŒ‰éˆ•ï¼Œè¢‹å­é‡‘é¡å°±æœƒæ­¸é›¶ã€‚é€™ä¸æœƒå½±éŸ¿æ‚¨çš„æ”¯å‡ºæ­·å²ç´€éŒ„ï¼Œåªæ˜¯å¹«æ‚¨å°å¸³ã€‚</p>
                    </div>
                </div>
            </div>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- LEFT COLUMN: INPUTS & SETTINGS -->
            <div class="lg:col-span-5 space-y-6">
                
                <!-- Section 1: Income -->
                <section class="card p-6 border-l-4 border-[#D4A373]">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold flex items-center gap-2">
                            <span>ğŸ’°</span> æ”¶å…¥ç›¤é»
                        </h2>
                        <button onclick="app.addItem('income')" class="text-sm bg-stone-100 hover:bg-stone-200 px-3 py-1 rounded text-stone-600 transition">+ æ–°å¢é …ç›®</button>
                    </div>
                    <div id="incomeList" class="space-y-2 max-h-48 overflow-y-auto scroller pr-2">
                        <!-- Dynamic Income Items -->
                    </div>
                    <div class="pt-4 border-t mt-4 flex justify-between items-center font-bold text-lg text-stone-700">
                        <span>ç¸½æ”¶å…¥</span>
                        <span id="totalIncomeDisplay">$0</span>
                    </div>
                </section>

                <!-- Section 2: Fixed Expenses -->
                <section class="card p-6 border-l-4 border-[#A3B18A]">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold flex items-center gap-2">
                            <span>ğŸ </span> å›ºå®šæ”¯å‡º
                        </h2>
                        <button onclick="app.addItem('fixed')" class="text-sm bg-stone-100 hover:bg-stone-200 px-3 py-1 rounded text-stone-600 transition">+ æ–°å¢é …ç›®</button>
                    </div>
                    <div id="fixedList" class="space-y-2 max-h-48 overflow-y-auto scroller pr-2">
                        <!-- Dynamic Fixed Items -->
                    </div>
                    <div class="pt-4 border-t mt-4 flex justify-between items-center font-bold text-stone-700">
                        <span>å›ºå®šæ”¯å‡ºç¸½è¨ˆ</span>
                        <span id="totalFixedDisplay">$0</span>
                    </div>
                </section>

                <!-- Section 3: Debt Management -->
                <section class="card p-6 border-l-4 border-[#E63946]">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold flex items-center gap-2">
                            <span>ğŸ’³</span> è² å‚µç®¡ç†
                        </h2>
                        <button onclick="app.toggleDebtSection()" class="text-xs bg-stone-100 hover:bg-stone-200 px-3 py-1 rounded text-stone-600 transition" id="debtToggleBtn">æˆ‘æœ‰è² å‚µ</button>
                    </div>
                    
                    <div id="debtContainer" class="hidden">
                        <div class="flex justify-end mb-2">
                             <button onclick="app.addItem('debt')" class="text-sm bg-stone-100 px-3 py-1 rounded hover:bg-stone-200 transition">+ æ–°å¢å‚µå‹™</button>
                        </div>
                        <div id="debtList" class="space-y-4 max-h-80 overflow-y-auto scroller pr-2 mb-4">
                            <!-- Dynamic Debt Items -->
                        </div>
                        <div class="pt-4 border-t border-stone-200 space-y-1">
                            <div class="flex justify-between items-center font-bold text-[#E63946]">
                                <span>æ¯æœˆæ‡‰ç¹³ç¸½è¨ˆ (å½±éŸ¿é ç®—)</span>
                                <span id="totalDebtDisplay">$0</span>
                            </div>
                            <div class="flex justify-between items-center text-sm text-stone-500">
                                <span>ç¸½å‰©é¤˜æœ¬é‡‘è¦æ¨¡</span>
                                <span id="totalPrincipalDisplay">$0</span>
                            </div>
                        </div>
                    </div>
                    <div id="noDebtMessage" class="text-sm text-stone-400 italic text-center py-4">
                        ç›®å‰è¨­å®šç‚ºç„¡è² å‚µæ¨¡å¼ï¼Œå°‡æ¡ç”¨ 30/50/20 é»ƒé‡‘å­˜éŒ¢æ¯”ä¾‹ã€‚
                    </div>
                </section>

            </div>

            <!-- RIGHT COLUMN: ALLOCATION & INTERACTIVE BOOKS -->
            <div class="lg:col-span-7 space-y-6">

                <!-- Allocation Dashboard -->
                <section class="card p-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                        <h2 class="text-xl font-bold mb-2 md:mb-0 flex items-center gap-2">ğŸ“Š è³‡é‡‘åˆ†é…å„€è¡¨æ¿</h2>
                        <button onclick="app.resetMasterRatios()" class="text-xs bg-stone-100 hover:bg-stone-200 px-3 py-1.5 rounded text-stone-600 transition shadow-sm font-bold border border-stone-200">é‚„åŸç³»çµ±å»ºè­°æ¯”ä¾‹</button>
                    </div>
                    
                    <div class="flex items-center gap-2 mb-6">
                        <p class="text-sm text-stone-500">å¯ç”¨ç¸½é¤˜é¡ <span id="discretionaryDisplay" class="font-bold text-lg text-stone-700">$0</span></p>
                        <div id="mainUnallocatedBadge" class="text-xs font-bold px-2 py-1 rounded-md hidden">å¾…åˆ†é…: $0</div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                        <div class="chart-container" title="é»æ“Šå€å¡Šå¯åˆ‡æ›ä¸‹æ–¹å¸³æœ¬">
                             <canvas id="allocationChart"></canvas>
                        </div>
                        <div class="space-y-4">
                            <!-- Editable Allocation Details -->
                            <div class="p-3 bg-stone-50 rounded-xl border border-stone-200 relative overflow-hidden transition-all focus-within:ring-2 focus-within:ring-[#D4A373]/50 hover:shadow-md group">
                                <div class="absolute top-0 left-0 w-1.5 h-full bg-[#D4A373]"></div>
                                <div class="flex justify-between items-center mb-2 pl-3">
                                    <span class="font-bold text-stone-700 cursor-pointer hover:text-[#D4A373] transition-colors" onclick="app.switchTab('budget')">ğŸ“– é ç®—æœ¬</span>
                                    <div class="flex items-center gap-1 text-sm font-bold text-stone-500">
                                        <input type="number" id="master-ratio-budget" onchange="app.updateMasterAllocation('budget', 'ratio', this.value)" step="0.1" class="w-14 text-right bg-white border border-stone-200 rounded px-1 py-0.5 focus:outline-none focus:border-[#D4A373] transition-colors">%
                                    </div>
                                </div>
                                <div class="flex justify-between items-center pl-3">
                                    <div class="text-xs text-stone-500">ä¾›æœ¬æœˆæ—¥å¸¸èŠ±è²»ä½¿ç”¨</div>
                                    <div class="flex items-center text-[#D4A373] font-bold">
                                        $ <input type="number" id="master-amount-budget" onchange="app.updateMasterAllocation('budget', 'amount', this.value)" class="w-24 text-right bg-white border border-[#D4A373]/30 rounded px-1 py-0.5 ml-1 focus:outline-none focus:border-[#D4A373] transition-colors">
                                    </div>
                                </div>
                            </div>

                            <div class="p-3 bg-stone-50 rounded-xl border border-stone-200 relative overflow-hidden transition-all focus-within:ring-2 focus-within:ring-[#A3B18A]/50 hover:shadow-md group">
                                <div class="absolute top-0 left-0 w-1.5 h-full bg-[#A3B18A]"></div>
                                <div class="flex justify-between items-center mb-2 pl-3">
                                    <span class="font-bold text-stone-700 cursor-pointer hover:text-[#A3B18A] transition-colors" onclick="app.switchTab('presave')">âœˆï¸ é å­˜æœ¬</span>
                                    <div class="flex items-center gap-1 text-sm font-bold text-stone-500">
                                        <input type="number" id="master-ratio-presave" onchange="app.updateMasterAllocation('presave', 'ratio', this.value)" step="0.1" class="w-14 text-right bg-white border border-stone-200 rounded px-1 py-0.5 focus:outline-none focus:border-[#A3B18A] transition-colors">%
                                    </div>
                                </div>
                                <div class="flex justify-between items-center pl-3">
                                    <div class="text-xs text-stone-500">ä¸‹æ–¹è‡ªç”±åˆ†é…çµ¦å„é …é¡˜æœ›</div>
                                    <div class="flex items-center text-[#A3B18A] font-bold">
                                        $ <input type="number" id="master-amount-presave" onchange="app.updateMasterAllocation('presave', 'amount', this.value)" class="w-24 text-right bg-white border border-[#A3B18A]/30 rounded px-1 py-0.5 ml-1 focus:outline-none focus:border-[#A3B18A] transition-colors">
                                    </div>
                                </div>
                            </div>

                            <div class="p-3 bg-stone-50 rounded-xl border border-stone-200 relative overflow-hidden transition-all focus-within:ring-2 focus-within:ring-[#E63946]/50 hover:shadow-md group">
                                <div class="absolute top-0 left-0 w-1.5 h-full bg-[#E63946]"></div>
                                <div class="flex justify-between items-center mb-2 pl-3">
                                    <span class="font-bold text-stone-700 cursor-pointer hover:text-[#E63946] transition-colors" onclick="app.switchTab('savings')">ğŸ¦ å­˜éŒ¢æœ¬</span>
                                    <div class="flex items-center gap-1 text-sm font-bold text-stone-500">
                                        <input type="number" id="master-ratio-savings" onchange="app.updateMasterAllocation('savings', 'ratio', this.value)" step="0.1" class="w-14 text-right bg-white border border-stone-200 rounded px-1 py-0.5 focus:outline-none focus:border-[#E63946] transition-colors">%
                                    </div>
                                </div>
                                <div class="flex justify-between items-center pl-3">
                                    <div class="text-xs text-stone-500">ä¸‹æ–¹è‡ªç”±åˆ†é…çµ¦å­˜éŒ¢ç›®æ¨™</div>
                                    <div class="flex items-center text-[#E63946] font-bold">
                                        $ <input type="number" id="master-amount-savings" onchange="app.updateMasterAllocation('savings', 'amount', this.value)" class="w-24 text-right bg-white border border-[#E63946]/30 rounded px-1 py-0.5 ml-1 focus:outline-none focus:border-[#E63946] transition-colors">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Shared Unallocated Savings Header -->
                <div class="flex flex-col md:flex-row justify-between items-center bg-stone-800 text-white p-5 rounded-2xl shadow-lg gap-4">
                    <div class="flex items-center gap-3">
                        <div class="text-3xl">ğŸ’°</div>
                        <div>
                            <h3 class="font-bold text-stone-200 tracking-wider">æœªåˆ†é…çµé¤˜æ°´åº« (å«éå»æœˆçµ)</h3>
                            <p class="text-xs text-stone-400 mt-1">æ‰‹å‹•èª¿é«˜ç›®æ¨™ã€Œå·²ç´¯ç©ã€æ™‚ï¼Œå°‡è‡ªå‹•å¾æ°´åº«æ‰£æ¬¾</p>
                        </div>
                    </div>
                    <div class="text-3xl font-black text-[#D4A373] tracking-wider bg-stone-900 px-5 py-2 rounded-xl border border-stone-700 unallocatedDisplayGlobal">
                        $0
                    </div>
                </div>

                <!-- Detailed Books Management (TABS) -->
                <section class="card p-0 overflow-hidden flex flex-col" id="bookTabsSection">
                    <!-- Tabs Header -->
                    <div class="flex border-b border-stone-200 bg-stone-50 px-6 pt-4 gap-6 relative overflow-x-auto scroller">
                        <button onclick="app.switchTab('budget')" id="tab-btn-budget" class="pb-3 text-lg font-bold text-[#D4A373] border-b-2 border-[#D4A373] transition-colors focus:outline-none whitespace-nowrap">
                            ğŸ“– é ç®—æœ¬
                        </button>
                        <button onclick="app.switchTab('presave')" id="tab-btn-presave" class="pb-3 text-lg font-bold text-stone-400 border-b-2 border-transparent hover:text-stone-600 transition-colors focus:outline-none whitespace-nowrap">
                            âœˆï¸ é å­˜æœ¬
                        </button>
                        <button onclick="app.switchTab('savings')" id="tab-btn-savings" class="pb-3 text-lg font-bold text-stone-400 border-b-2 border-transparent hover:text-stone-600 transition-colors focus:outline-none whitespace-nowrap">
                            ğŸ¦ å­˜éŒ¢æœ¬
                        </button>
                    </div>

                    <div class="p-6">
                        <!-- TAB 1: BUDGET BOOK -->
                        <div id="tab-content-budget" class="tab-content active">
                            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-4 pb-3 gap-3 border-b border-stone-100">
                                <p class="text-sm text-stone-500">è¨˜éŒ„æ—¥å¸¸é–‹éŠ·ï¼Œæ§ç®¡ç”Ÿæ´»è²»é€²åº¦ã€‚</p>
                                <div class="flex flex-wrap items-center gap-2">
                                    <div id="budgetUnallocatedBadge" class="text-xs font-bold px-3 py-1.5 rounded-full bg-stone-100 text-stone-600 shadow-inner border border-stone-200">
                                        å¾…åˆ†é…: $0
                                    </div>
                                    <button onclick="app.autoDistribute('budget')" class="text-xs text-[#D4A373] bg-[#D4A373] bg-opacity-10 hover:bg-opacity-20 border border-[#D4A373] border-opacity-30 rounded px-2 py-1.5 transition shadow-sm font-bold">è‡ªå‹•ä¾æ¯”ä¾‹åˆ†é…</button>
                                    <button onclick="app.addItem('budget')" class="text-xs bg-stone-100 hover:bg-stone-200 px-3 py-1.5 rounded text-stone-600 transition border border-stone-200">+ æ–°å¢é¡åˆ¥</button>
                                </div>
                            </div>

                            <div id="budgetList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- Dynamic Budget Categories -->
                            </div>

                            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- Transaction History -->
                                <div class="p-4 bg-stone-50 rounded-xl border border-stone-100 shadow-sm">
                                    <h3 class="font-bold text-stone-700 text-sm mb-3 flex items-center gap-1"><span>ğŸ“</span> æœ¬æœˆæ”¯å‡ºç´€éŒ„</h3>
                                    <div id="txList" class="space-y-2 max-h-40 overflow-y-auto scroller text-sm pr-1"></div>
                                </div>

                                <!-- Credit Card Logic -->
                                <div class="p-4 bg-yellow-50 rounded-xl border border-yellow-200 flex flex-col justify-between shadow-sm relative overflow-hidden">
                                    <div class="absolute top-0 right-0 w-16 h-16 bg-yellow-100 rounded-bl-full -mr-8 -mt-8 opacity-50"></div>
                                    <div>
                                        <h3 class="font-bold text-yellow-800 text-sm mb-2 flex items-center gap-1"><span>ğŸ’³</span> ä¿¡ç”¨å¡æ”¶ç´è¢‹</h3>
                                        <p class="text-xs text-yellow-700 mb-3 leading-relaxed">è¨˜å¸³é¸æ“‡ã€Œåˆ·å¡ã€çš„é‡‘é¡æœƒç´¯ç©åœ¨æ­¤ã€‚è«‹è¨˜å¾—å°‡å°æ‡‰ç¾é‡‘æ”¾å…¥å¯¦é«”ä¿¡å°ï¼</p>
                                    </div>
                                    <div class="bg-white p-3 rounded-lg border border-yellow-200 text-center shadow-inner flex flex-col items-center justify-center gap-2">
                                        <div class="text-xs text-yellow-600 font-bold uppercase tracking-wider">æ‡‰ä¿ç•™å¡è²»ç¾é‡‘</div>
                                        <div class="text-3xl font-black text-yellow-800 tracking-tight" id="ccPouchTotal">$0</div>
                                        <button onclick="app.clearCCPouch()" class="mt-1 text-[10px] bg-yellow-100 hover:bg-yellow-200 text-yellow-700 font-bold py-1 px-3 rounded-full transition border border-yellow-300 shadow-sm">
                                            âœ… å·²ç¹³æ¸…å¡è²» (æ­¸é›¶)
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- TAB 2: PRESAVE BOOK -->
                        <div id="tab-content-presave" class="tab-content">
                            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-4 bg-[#A3B18A]/10 p-4 rounded-xl border border-[#A3B18A]/30 gap-3">
                                <div>
                                    <h3 class="font-bold text-[#6B7A56] text-lg">âœˆï¸ é¡˜æœ›æ¸…å–®èˆ‡é å­˜ç›®æ¨™</h3>
                                    <p class="text-xs text-stone-500 mt-1">ä¾†è‡ªä¸Šæ–¹å„€è¡¨æ¿çš„é å­˜åˆ†é…ç¸½é¡ï¼š<strong id="headerPresaveAlloc" class="text-[#A3B18A] text-sm font-bold">--</strong></p>
                                </div>
                                <div class="flex flex-wrap items-center gap-2">
                                    <div id="presaveUnallocatedBadge" class="text-xs font-bold px-3 py-1.5 rounded-full bg-white text-stone-600 shadow-sm border border-[#A3B18A]/30">
                                        æœ¬æœˆå¾…åˆ†é…: $0
                                    </div>
                                    <button onclick="app.autoDistribute('presave')" class="text-xs text-[#6B7A56] bg-white hover:bg-stone-50 border border-[#A3B18A]/50 rounded px-2 py-1.5 transition shadow-sm font-bold">è‡ªå‹•ä¾æ¯”ä¾‹åˆ†é…</button>
                                    <button onclick="app.addItem('presave')" class="text-xs bg-white hover:bg-stone-50 text-[#6B7A56] font-bold py-1.5 px-3 rounded shadow-sm border border-[#A3B18A]/30 transition">+ æ–°å¢é¡˜æœ›</button>
                                </div>
                            </div>
                            
                            <div id="presaveList" class="grid grid-cols-1 gap-4">
                                <!-- Dynamic Presave Goals -->
                            </div>
                        </div>

                        <!-- TAB 3: SAVINGS BOOK -->
                        <div id="tab-content-savings" class="tab-content">
                            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-4 bg-[#E63946]/10 p-4 rounded-xl border border-[#E63946]/30 gap-3">
                                <div>
                                    <h3 class="font-bold text-[#A62A35] text-lg">ğŸ¦ å­˜éŒ¢ç›®æ¨™èˆ‡ç·Šæ€¥é å‚™é‡‘</h3>
                                    <p class="text-xs text-stone-600 mt-1">ä¾†è‡ªä¸Šæ–¹å„€è¡¨æ¿çš„å­˜éŒ¢åˆ†é…ç¸½é¡ï¼š<strong id="headerSavingsAlloc" class="text-[#E63946] font-bold">--</strong></p>
                                </div>
                                <div class="flex flex-wrap items-center gap-2">
                                    <div id="savingsUnallocatedBadge" class="text-xs font-bold px-3 py-1.5 rounded-full bg-white text-stone-600 shadow-sm border border-[#E63946]/30">
                                        æœ¬æœˆå¾…åˆ†é…: $0
                                    </div>
                                    <button onclick="app.autoDistribute('savings')" class="text-xs text-[#A62A35] bg-white hover:bg-stone-50 border border-[#E63946]/50 rounded px-2 py-1.5 transition shadow-sm font-bold">è‡ªå‹•ä¾æ¯”ä¾‹åˆ†é…</button>
                                    <button onclick="app.addItem('savings')" class="text-xs bg-white hover:bg-stone-50 text-[#A62A35] font-bold py-1.5 px-3 rounded shadow-sm border border-[#E63946]/30 transition">+ æ–°å¢ç›®æ¨™</button>
                                </div>
                            </div>
                            
                            <div id="savingsList" class="grid grid-cols-1 gap-4">
                                <!-- Dynamic Savings Goals -->
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Monthly Reset -->
                <section class="card p-6 bg-stone-800 text-stone-200">
                    <h2 class="text-xl font-bold mb-2">ğŸ—“ï¸ æœˆæœ«çµç®—èˆ‡å°å­˜</h2>
                    <p class="text-xs text-stone-400 mb-4 leading-relaxed">é»æ“Šå¾Œï¼Œå„å¸³æœ¬å…§ã€Œæœ¬æœˆåˆ†é…ã€çš„é‡‘é¡æœƒè½‰ç‚ºæ­£å¼çš„ã€Œå·²ç´¯ç©ã€ï¼ŒæœªèŠ±å®Œ/æœªåˆ†é…çš„çµé¤˜å°‡å…¨æ•¸åŒ¯å…¥<strong class="text-[#D4A373]">çµé¤˜æ°´åº«</strong>ã€‚è¨˜å¸³æ˜ç´°å°‡å°å­˜è‡³æ­·å²ç´€éŒ„ã€‚</p>
                    
                    <div class="flex items-center justify-between bg-stone-700 p-4 rounded-lg mb-4 border border-stone-600">
                        <div>
                            <div class="text-xs text-stone-400 mb-1">æœ¬æ¬¡çµç®—å°‡åŒ¯å…¥æ°´åº«</div>
                            <div class="text-xl font-bold text-green-400" id="monthEndBalance">$0</div>
                        </div>
                        <div class="text-2xl text-stone-500 px-2">â”</div>
                        <div class="text-right">
                            <div class="text-xs text-stone-400 mb-1">æ°´åº«çµç®—å¾Œç¸½é‡‘é¡</div>
                            <div class="text-xl font-bold text-[#D4A373]" id="expectedReservoir">$0</div>
                        </div>
                    </div>

                    <button onclick="app.resetMonth()" class="w-full py-4 bg-[#D4A373] hover:bg-[#C39262] text-white font-bold rounded-xl transition shadow-lg text-lg flex items-center justify-center gap-2">
                        <span>âœ…</span> åŸ·è¡Œæœˆçµç®— (å­˜å…¥é€²åº¦ä¸¦æ¸…ç©ºå¸³æœ¬)
                    </button>
                </section>

            </div>
        </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div id="editModal" class="hidden fixed inset-0 bg-stone-900 bg-opacity-60 flex items-center justify-center z-[150] p-4 transition-opacity">
        <div class="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl">
            <h3 class="font-bold text-xl mb-4 text-stone-800 border-b border-stone-100 pb-2">âœï¸ ç·¨è¼¯æ”¯å‡ºç´€éŒ„</h3>
            <input type="hidden" id="editTxId">
            <div class="mb-4">
                <label class="block text-sm font-medium text-stone-600 mb-1">æ”¯å‡ºé‡‘é¡</label>
                <input type="number" id="editTxAmount" class="input-std text-lg font-bold text-stone-700">
            </div>
            <div class="mb-6">
                <label class="block text-sm font-medium text-stone-600 mb-1">ä»˜æ¬¾æ–¹å¼</label>
                <select id="editTxMethod" class="input-std bg-white text-stone-700">
                    <option value="cash">ğŸ’µ ç¾é‡‘</option>
                    <option value="credit">ğŸ’³ åˆ·å¡</option>
                </select>
            </div>
            <div class="flex justify-end gap-3 pt-2 border-t border-stone-100">
                <button onclick="app.closeEditModal()" class="px-5 py-2 bg-stone-100 hover:bg-stone-200 rounded-lg text-sm text-stone-600 font-medium transition">å–æ¶ˆ</button>
                <button onclick="app.saveEditTx()" class="px-5 py-2 bg-[#D4A373] hover:bg-[#C39262] text-white rounded-lg text-sm font-bold transition shadow-sm">å„²å­˜ä¿®æ”¹</button>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="hidden fixed inset-0 bg-stone-900 bg-opacity-70 flex items-center justify-center z-[150] p-4 transition-opacity duration-300">
        <div class="bg-white rounded-2xl w-full max-w-2xl h-[85vh] flex flex-col shadow-2xl overflow-hidden transform transition-transform">
            <div class="p-6 border-b border-stone-200 flex justify-between items-center bg-stone-50">
                <div>
                    <h3 class="font-bold text-2xl text-stone-800 flex items-center gap-2">ğŸ•°ï¸ æ­·å²ç´€éŒ„æ­¸æª”</h3>
                    <p class="text-xs text-stone-500 mt-1">é»æ“Šæœˆä»½å¡ç‰‡å¯å±•é–‹æŸ¥çœ‹è©³ç´°æ”¶æ”¯èˆ‡æ˜ç´°</p>
                </div>
                <button onclick="app.closeHistoryModal()" class="text-stone-400 hover:text-stone-700 text-3xl font-bold leading-none w-10 h-10 rounded-full hover:bg-stone-200 transition flex items-center justify-center">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto flex-1 scroller bg-stone-100/50" id="historyListContainer">
                <!-- History Items Injected Here -->
            </div>
        </div>
    </div>

    <!-- MAIN APP LOGIC -->
    <script>
        const defaultBudget = [
            { id: 'cat-1', name: 'æ¯é€±é¤è²»', budget: 0, ratio: 40 },
            { id: 'cat-2', name: 'äº¤é€šè²»', budget: 0, ratio: 15 },
            { id: 'cat-3', name: 'ç¾å¦/ä¿é¤Š', budget: 0, ratio: 15 },
            { id: 'cat-4', name: 'ç”Ÿæ´»é›œæ”¯', budget: 0, ratio: 20 },
            { id: 'cat-5', name: 'å…¶ä»–/é å‚™', budget: 0, ratio: 10 }
        ];

        window.app = {
            data: {
                incomes: [
                    { id: 'inc-1', name: 'æœˆè–ªè³‡ (å¯¦é ˜)', amount: 0 },
                    { id: 'inc-2', name: 'é¡å¤–çé‡‘/å‰¯æ¥­', amount: 0 }
                ],
                fixedExpenses: [{ id: 1, name: 'æˆ¿ç§Ÿ', amount: 0 }, { id: 2, name: 'æ°´é›»è²»', amount: 0 }],
                debts: [], 
                hasDebt: false,
                transactions: [],
                
                masterRatios: { budget: 50, presave: 20, savings: 30 },
                isManualMasterRatio: false,

                budgetItems: JSON.parse(JSON.stringify(defaultBudget)),
                isManualBudget: false,
                
                presaveGoals: [{ id: 'ps-1', name: 'å¹´åº¦æ—…éŠ', target: 30000, accumulated: 0, budget: 0, ratio: 10 }],
                isManualPresave: false,
                
                savingsGoals: [{ id: 'sv-1', name: 'ç·Šæ€¥é å‚™é‡‘ (6å€‹æœˆç”Ÿæ´»è²»)', target: 150000, accumulated: 0, budget: 0, ratio: 10 }],
                isManualSavings: false,
                
                unallocatedSavings: 0,
                ccPaidAmount: 0 
            },
            historyRecords: [],
            charts: {},
            saveTimeout: null,
            activeTab: 'budget', 
            currentPools: { budget: 0, presave: 0, savings: 0 },

            init() {
                const now = new Date();
                document.getElementById('currentDateDisplay').textContent = `${now.getFullYear()}å¹´ ${now.getMonth() + 1}æœˆ`;
                
                // State Migrations
                if(this.data.salary !== undefined || this.data.bonus !== undefined) {
                    if(!this.data.incomes || this.data.incomes.length === 0) {
                        this.data.incomes = [
                            { id: 'inc-1', name: 'æœˆè–ªè³‡ (å¯¦é ˜)', amount: this.data.salary || 0 },
                            { id: 'inc-2', name: 'é¡å¤–çé‡‘/æ”¶å…¥', amount: this.data.bonus || 0 }
                        ];
                    }
                    delete this.data.salary;
                    delete this.data.bonus;
                }
                if(!this.data.incomes) this.data.incomes = [{ id: 'inc-1', name: 'æœˆè–ªè³‡ (å¯¦é ˜)', amount: 0 }];
                if(!this.data.presaveGoals) this.data.presaveGoals = [];
                if(!this.data.savingsGoals) this.data.savingsGoals = [];
                if(this.data.ccPaidAmount === undefined) this.data.ccPaidAmount = 0;
                if(!this.data.masterRatios) this.data.masterRatios = { budget: 50, presave: 20, savings: 30 };
                
                // Migrate old 'current' to 'accumulated'
                this.data.presaveGoals.forEach(g => { 
                    if(g.current !== undefined) { g.accumulated = g.current; delete g.current; }
                    if(g.ratio === undefined) g.ratio = 10;
                    if(g.budget === undefined) g.budget = 0;
                });
                this.data.savingsGoals.forEach(g => { 
                    if(g.current !== undefined) { g.accumulated = g.current; delete g.current; }
                    if(g.ratio === undefined) g.ratio = 10;
                    if(g.budget === undefined) g.budget = 0;
                });

                this.initChart();
                this.syncInputsFromData();
                this.renderIncomeList();
                this.renderFixedList();
                this.renderDebtList();
                this.calculate();
            },

            // --- Custom Dialog System ---
            showDialog(title, message, type = 'alert', onConfirm = null) {
                document.getElementById('dialogTitle').innerHTML = title;
                document.getElementById('dialogMessage').innerHTML = message.replace(/\n/g, '<br>');
                const btnContainer = document.getElementById('dialogButtons');
                btnContainer.innerHTML = '';
                
                const modal = document.getElementById('dialogModal');
                const modalContent = document.getElementById('dialogModalContent');
                
                if (type === 'confirm') {
                    const cancelBtn = document.createElement('button');
                    cancelBtn.className = 'px-5 py-2.5 bg-stone-100 hover:bg-stone-200 rounded-xl text-sm text-stone-600 font-bold transition';
                    cancelBtn.textContent = 'å–æ¶ˆ';
                    cancelBtn.onclick = () => this.closeDialog();
                    
                    const confirmBtn = document.createElement('button');
                    confirmBtn.className = 'px-5 py-2.5 bg-[#D4A373] hover:bg-[#C39262] text-white rounded-xl text-sm font-bold transition shadow-sm';
                    confirmBtn.textContent = 'ç¢ºå®šåŸ·è¡Œ';
                    confirmBtn.onclick = () => {
                        this.closeDialog();
                        if (onConfirm) onConfirm();
                    };
                    btnContainer.appendChild(cancelBtn);
                    btnContainer.appendChild(confirmBtn);
                } else {
                    const okBtn = document.createElement('button');
                    okBtn.className = 'px-6 py-2.5 bg-[#D4A373] hover:bg-[#C39262] text-white rounded-xl text-sm font-bold transition shadow-sm w-full';
                    okBtn.textContent = 'æˆ‘çŸ¥é“äº†';
                    okBtn.onclick = () => {
                        this.closeDialog();
                        if(onConfirm) onConfirm();
                    }
                    btnContainer.appendChild(okBtn);
                }
                
                modal.classList.remove('hidden');
                setTimeout(() => { modalContent.classList.remove('scale-95'); modalContent.classList.add('scale-100'); }, 10);
            },
            closeDialog() {
                const modalContent = document.getElementById('dialogModalContent');
                modalContent.classList.remove('scale-100');
                modalContent.classList.add('scale-95');
                setTimeout(() => { document.getElementById('dialogModal').classList.add('hidden'); }, 150);
            },

            // --- TABS LOGIC ---
            switchTab(tabName) {
                this.activeTab = tabName;
                const tabs = ['budget', 'presave', 'savings'];
                const colors = { budget: '#D4A373', presave: '#A3B18A', savings: '#E63946' };
                
                tabs.forEach(t => {
                    const btn = document.getElementById(`tab-btn-${t}`);
                    const content = document.getElementById(`tab-content-${t}`);
                    if (t === tabName) {
                        btn.className = `pb-3 text-lg font-bold text-[${colors[t]}] border-b-2 border-[${colors[t]}] transition-colors focus:outline-none whitespace-nowrap`;
                        content.classList.add('active');
                    } else {
                        btn.className = `pb-3 text-lg font-bold text-stone-400 border-b-2 border-transparent hover:text-stone-600 transition-colors focus:outline-none whitespace-nowrap`;
                        content.classList.remove('active');
                    }
                });
                document.getElementById('bookTabsSection').scrollIntoView({behavior: 'smooth', block: 'start'});
            },

            syncInputsFromData() {
                if(this.data.hasDebt) {
                    document.getElementById('debtContainer').classList.remove('hidden');
                    document.getElementById('noDebtMessage').classList.add('hidden');
                    const btn = document.getElementById('debtToggleBtn');
                    btn.textContent = "åˆ‡æ›ç‚ºç„¡è² å‚µ";
                    btn.classList.add('bg-red-100', 'text-red-600');
                }
            },

            initChart() {
                if(this.charts.allocation) this.charts.allocation.destroy();
                const ctx = document.getElementById('allocationChart').getContext('2d');
                this.charts.allocation = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['é ç®—æœ¬ (ç”Ÿæ´»)', 'é å­˜æœ¬ (æœªä¾†)', 'å­˜éŒ¢æœ¬ (æŠ•è³‡/é‚„æ¬¾)'],
                        datasets: [{
                            data: [50, 20, 30],
                            backgroundColor: ['#D4A373', '#A3B18A', '#E63946'],
                            borderWidth: 0,
                            hoverOffset: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom', labels: { font: { family: "'Noto Sans TC', sans-serif" }, usePointStyle: true, padding: 20 } },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) label += ': ';
                                        if (context.parsed !== null) label += new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(context.parsed);
                                        return label;
                                    }
                                }
                            }
                        },
                        onClick: (e, elements) => {
                            if (elements.length > 0) {
                                const idx = elements[0].index;
                                const tabs = ['budget', 'presave', 'savings'];
                                if(idx < 3) this.switchTab(tabs[idx]);
                            }
                        }
                    }
                });
            },

            calculateAndSave() {
                this.calculate();
                this.requestSave();
            },
            requestSave() {
                if (window.db && window.user) {
                    clearTimeout(this.saveTimeout);
                    this.saveTimeout = setTimeout(() => {
                        if(window.saveStateToCloud) window.saveStateToCloud(this.data);
                    }, 1500);
                }
            },

            getDiscretionary() {
                const totalIncome = this.data.incomes.reduce((sum, item) => sum + (item.amount || 0), 0);
                const totalFixed = this.data.fixedExpenses.reduce((sum, item) => sum + (item.amount || 0), 0);
                let totalDebtMonthly = this.data.hasDebt ? this.data.debts.reduce((sum, item) => sum + (item.monthly || 0), 0) : 0;
                return Math.max(0, totalIncome - totalFixed - totalDebtMonthly);
            },

            // --- Dashboard Master Allocation Edits ---
            updateMasterAllocation(type, field, value) {
                this.data.isManualMasterRatio = true;
                let numVal = Number(value) || 0;
                let discretionary = this.getDiscretionary();
                
                if (field === 'ratio') {
                    if (numVal < 0) numVal = 0;
                    this.data.masterRatios[type] = numVal;
                } else if (field === 'amount') {
                    if (discretionary > 0 && numVal >= 0) {
                        this.data.masterRatios[type] = Number(((numVal / discretionary) * 100).toFixed(1));
                    } else {
                        this.data.masterRatios[type] = 0;
                    }
                }
                this.calculateAndSave();
            },

            resetMasterRatios() {
                this.showDialog('é‚„åŸç³»çµ±æ¯”ä¾‹', 'ç¢ºå®šè¦é‚„åŸåˆ°ç³»çµ±å»ºè­°çš„é»ƒé‡‘æ¯”ä¾‹å—ï¼Ÿ', 'confirm', () => {
                    this.data.isManualMasterRatio = false;
                    this.calculateAndSave();
                });
            },

            // --- Core Calculation ---
            calculate() {
                const totalIncome = this.data.incomes.reduce((sum, item) => sum + (item.amount || 0), 0);
                document.getElementById('totalIncomeDisplay').textContent = this.formatMoney(totalIncome);

                const totalFixed = this.data.fixedExpenses.reduce((sum, item) => sum + (item.amount || 0), 0);
                document.getElementById('totalFixedDisplay').textContent = this.formatMoney(totalFixed);

                let totalDebtMonthly = 0;
                if (this.data.hasDebt) {
                    totalDebtMonthly = this.data.debts.reduce((sum, item) => sum + (item.monthly || 0), 0);
                    let totalDebtPrincipal = this.data.debts.reduce((sum, item) => sum + (item.principal || 0), 0);
                    document.getElementById('totalPrincipalDisplay').textContent = this.formatMoney(totalDebtPrincipal);
                }
                document.getElementById('totalDebtDisplay').textContent = this.formatMoney(totalDebtMonthly);

                let discretionary = Math.max(0, totalIncome - totalFixed - totalDebtMonthly);
                
                // 1. Calculate Master Ratios
                if (!this.data.isManualMasterRatio) {
                    if (!this.data.hasDebt) {
                        this.data.masterRatios = { budget: 50, presave: 20, savings: 30 };
                    } else {
                        this.data.masterRatios = { budget: 60, presave: 10, savings: 30 };
                    }
                }

                // 2. Calculate Dashboard Pools
                let bRatio = this.data.masterRatios.budget || 0;
                let pRatio = this.data.masterRatios.presave || 0;
                let sRatio = this.data.masterRatios.savings || 0;

                let budgetPool = Math.round((bRatio / 100) * discretionary);
                let presaveAmt = Math.round((pRatio / 100) * discretionary);
                let savingsAmt = Math.round((sRatio / 100) * discretionary);

                this.currentPools = { budget: budgetPool, presave: presaveAmt, savings: savingsAmt };

                // 3. Check for Over-allocation in Master Dashboard
                let totalAllocated = budgetPool + presaveAmt + savingsAmt;
                let mainUnallocated = discretionary - totalAllocated;
                
                const mainUnallocatedBadge = document.getElementById('mainUnallocatedBadge');
                if (mainUnallocated === 0 || discretionary === 0) {
                    mainUnallocatedBadge.classList.add('hidden');
                } else {
                    mainUnallocatedBadge.classList.remove('hidden');
                    if (mainUnallocated > 0) {
                        mainUnallocatedBadge.className = 'ml-2 text-xs px-2 py-1 rounded bg-green-100 text-green-700 border border-green-200';
                        mainUnallocatedBadge.textContent = `å¾…åˆ†é…é¡åº¦: ${this.formatMoney(mainUnallocated)}`;
                    } else {
                        mainUnallocatedBadge.className = 'ml-2 text-xs px-2 py-1 rounded bg-red-100 text-red-600 border border-red-200';
                        mainUnallocatedBadge.textContent = `âš ï¸ è¶…é¡åˆ†é…: ${this.formatMoney(mainUnallocated)}`;
                    }
                }

                document.getElementById('discretionaryDisplay').textContent = this.formatMoney(discretionary);

                // Update Dashboard Values (Inputs)
                document.getElementById('master-ratio-budget').value = bRatio;
                document.getElementById('master-amount-budget').value = budgetPool;
                
                document.getElementById('master-ratio-presave').value = pRatio;
                document.getElementById('master-amount-presave').value = presaveAmt;
                
                document.getElementById('master-ratio-savings').value = sRatio;
                document.getElementById('master-amount-savings').value = savingsAmt;
                
                // Update Tab Headers
                document.getElementById('headerPresaveAlloc').textContent = this.formatMoney(presaveAmt);
                document.getElementById('headerSavingsAlloc').textContent = this.formatMoney(savingsAmt);
                document.querySelectorAll('.unallocatedDisplayGlobal').forEach(el => el.textContent = this.formatMoney(this.data.unallocatedSavings || 0));

                // Chart Update (Add Unallocated Slice if > 0)
                let cLabels = ['é ç®—æœ¬ (ç”Ÿæ´»)', 'é å­˜æœ¬ (æœªä¾†)', 'å­˜éŒ¢æœ¬ (æŠ•è³‡/é‚„æ¬¾)'];
                let cColors = ['#D4A373', '#A3B18A', '#E63946'];
                let cData = [budgetPool, presaveAmt, savingsAmt];
                if(mainUnallocated > 0) {
                    cLabels.push('å¾…åˆ†é…é¡åº¦');
                    cColors.push('#E7E5E4');
                    cData.push(mainUnallocated);
                }
                this.charts.allocation.data.labels = cLabels;
                this.charts.allocation.data.datasets[0].backgroundColor = cColors;
                this.charts.allocation.data.datasets[0].data = cData;
                this.charts.allocation.update();

                // Auto-Distribute internal pools if uninitialized
                if (this._getSum(this.data.budgetItems, 'budget') === 0 && budgetPool > 0 && !this.data.isManualBudget) 
                    this._performRatioDistribution(this.data.budgetItems, budgetPool);
                
                if (this._getSum(this.data.presaveGoals, 'budget') === 0 && presaveAmt > 0 && !this.data.isManualPresave) 
                    this._performRatioDistribution(this.data.presaveGoals, presaveAmt);
                
                if (this._getSum(this.data.savingsGoals, 'budget') === 0 && savingsAmt > 0 && !this.data.isManualSavings) 
                    this._performRatioDistribution(this.data.savingsGoals, savingsAmt);

                // Render all tabs
                this.renderBudgetCategories(budgetPool);
                this.renderTransactions();
                this.renderGoals('presave', presaveAmt);
                this.renderGoals('savings', savingsAmt);
                this.calculateCC_And_Balance(budgetPool);
                this.calculateResetPreview();
            },

            _getSum(arr, field) { return arr.reduce((sum, item) => sum + (item[field] || 0), 0); },

            _performRatioDistribution(itemsArray, pool) {
                if(itemsArray.length === 0) return;
                let totalWeight = itemsArray.reduce((sum, item) => sum + (item.ratio || 10), 0);
                if (totalWeight === 0) totalWeight = 1; 
                
                let remaining = pool;
                itemsArray.forEach((item, index) => {
                    let weight = item.ratio || 10;
                    let alloc = Math.floor(pool * (weight / totalWeight));
                    if (index === itemsArray.length - 1) item.budget = remaining;
                    else { item.budget = alloc; remaining -= alloc; }
                });
            },

            autoDistribute(type) {
                this.calculate(); 
                let pool = this.currentPools[type];
                
                if (pool <= 0) {
                    this.showDialog('âš ï¸ ç³»çµ±æç¤º', `è©²å¸³æœ¬çš„ç¸½åˆ†é…é¡åº¦ç›®å‰ç‚º 0ï¼Œè«‹å…ˆåœ¨ä¸Šæ–¹ã€Œè³‡é‡‘åˆ†é…å„€è¡¨æ¿ã€ä¸­ç¢ºèªé‡‘é¡ï¼`, 'alert');
                    return;
                }

                this.showDialog('ğŸª„ è‡ªå‹•ä¾æ¯”ä¾‹åˆ†é…', 'ç¢ºå®šè¦æ ¹æ“šæ‚¨è¨­å®šçš„æ¬Šé‡æ¯”ä¾‹é‡æ–°åˆ†é…æœ¬æœˆé¡åº¦å—ï¼Ÿ\n<span class="text-red-500 font-bold">é€™å°‡è¦†è“‹æ‚¨åœ¨è©²å¸³æœ¬ä¸­æ‰‹å‹•è¨­å®šçš„æœ¬æœˆåˆ†é…é‡‘é¡ã€‚</span>', 'confirm', () => {
                    if(type === 'budget') { this.data.isManualBudget = false; this._performRatioDistribution(this.data.budgetItems, pool); }
                    if(type === 'presave') { this.data.isManualPresave = false; this._performRatioDistribution(this.data.presaveGoals, pool); }
                    if(type === 'savings') { this.data.isManualSavings = false; this._performRatioDistribution(this.data.savingsGoals, pool); }
                    this.calculateAndSave();
                });
            },

            updateItemField(type, index, field, newValue) {
                let val = Number(newValue);
                let arr;
                if(type === 'budget') { arr = this.data.budgetItems; if(field==='budget') this.data.isManualBudget = true; }
                if(type === 'presave') { arr = this.data.presaveGoals; if(field==='budget') this.data.isManualPresave = true; }
                if(type === 'savings') { arr = this.data.savingsGoals; if(field==='budget') this.data.isManualSavings = true; }
                
                if(field === 'ratio' && val < 0) val = 0;
                arr[index][field] = val;
                this.calculateAndSave();
            },

            // Handle funding target from Reservoir
            handleGoalFund(type, index, newValueStr, oldValue) {
                const goals = type === 'presave' ? this.data.presaveGoals : this.data.savingsGoals;
                let newValue = Number(newValueStr);
                if(isNaN(newValue)) newValue = oldValue;
                
                let delta = newValue - oldValue;
                
                if (delta > 0 && this.data.unallocatedSavings < delta) {
                    this.showDialog('âš ï¸ çµé¤˜ä¸è¶³', `æ‚¨æƒ³å¤šå­˜å…¥ ${this.formatMoney(delta)}ï¼Œä½†æ°´åº«ç›®å‰åªæœ‰ ${this.formatMoney(this.data.unallocatedSavings)}ã€‚\n\nè«‹é‡æ–°è¼¸å…¥è¼ƒå°çš„é‡‘é¡ï¼Œæˆ–ç­‰å¾…æœˆæœ«çµç®—è³‡é‡‘åŒ¯å…¥å¾Œå†åˆ†é…ã€‚`, 'alert', () => {
                        this.calculateAndSave(); // triggers re-render to revert input visually
                    });
                    return;
                }

                this.data.unallocatedSavings -= delta;
                goals[index].accumulated = newValue;
                this.calculateAndSave();
            },

            _updateTabBadge(badgeId, unallocated) {
                const badge = document.getElementById(badgeId);
                badge.className = 'text-xs font-bold px-3 py-1.5 rounded-full shadow-inner transition-colors border ';
                if (unallocated === 0) {
                    badge.className += 'bg-stone-100 text-stone-500 border-stone-200';
                    badge.textContent = `âšª å·²å®Œç¾åˆ†é…`;
                } else if (unallocated > 0) {
                    badge.className += 'bg-green-100 text-green-700 border-green-200';
                    badge.textContent = `ğŸŸ¢ å¾…åˆ†é…: ${this.formatMoney(unallocated)}`;
                } else {
                    badge.className += 'bg-red-100 text-red-600 border-red-200';
                    badge.textContent = `ğŸ”´ è¶…é¡åˆ†é…: ${this.formatMoney(unallocated)}`;
                }
            },

            renderBudgetCategories(budgetPool) {
                const listContainer = document.getElementById('budgetList');
                listContainer.innerHTML = '';
                
                let totalAllocated = this._getSum(this.data.budgetItems, 'budget');
                this._updateTabBadge('budgetUnallocatedBadge', budgetPool - totalAllocated);

                this.data.budgetItems.forEach((item, index) => {
                    let allocated = item.budget || 0;
                    let ratio = item.ratio !== undefined ? item.ratio : 10;
                    let spentForCat = this.data.transactions.filter(tx => tx.catId === item.id).reduce((sum, tx) => sum + tx.amount, 0);

                    const remainingItemBalance = allocated - spentForCat;
                    const balanceColor = remainingItemBalance < 0 ? 'text-red-500' : 'text-stone-600';

                    const div = document.createElement('div');
                    div.className = 'p-4 bg-white border border-stone-200 rounded-xl shadow-sm transition-all hover:border-[#D4A373] hover:shadow-md flex flex-col justify-between group';
                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <div class="w-3/4">
                                <input type="text" value="${item.name}" 
                                    onchange="app.updateBudgetItemName(${index}, this.value)" 
                                    class="font-bold text-stone-700 text-sm bg-transparent border-b border-transparent hover:border-stone-300 focus:border-[#D4A373] focus:outline-none w-full truncate pb-1 transition-colors" 
                                    placeholder="é¡åˆ¥åç¨±">
                                <div class="flex items-center text-[10px] text-stone-400 mt-1 gap-1">
                                    <span>è‡ªå‹•åˆ†é…æ¬Šé‡:</span>
                                    <input type="number" value="${ratio}" onchange="app.updateItemField('budget', ${index}, 'ratio', this.value)" class="w-10 border-b border-stone-200 text-center focus:outline-none focus:border-[#D4A373]">
                                </div>
                            </div>
                            <button onclick="app.removeBudgetItem(${index})" class="text-xl text-stone-300 hover:text-red-500 leading-none opacity-0 group-hover:opacity-100 transition-opacity" title="åˆªé™¤é¡åˆ¥">&times;</button>
                        </div>
                        
                        <div class="flex justify-between items-center text-xs mb-3 mt-2">
                            <div class="flex items-center gap-1 bg-stone-50 px-2 py-1.5 rounded border border-stone-100 focus-within:border-[#D4A373] transition-colors">
                                <span class="text-stone-400 font-bold">é ç®— $</span>
                                <input type="number" value="${allocated}" 
                                    onchange="app.updateItemField('budget', ${index}, 'budget', this.value)" 
                                    class="w-16 border-none text-stone-700 font-bold focus:outline-none bg-transparent text-right" 
                                    placeholder="0">
                            </div>
                            <span class="${balanceColor} font-bold text-[13px] bg-stone-50 px-2 py-1.5 rounded border border-stone-100">é¤˜é¡ ${this.formatMoney(remainingItemBalance)}</span>
                        </div>
                        
                        <div class="relative pt-1 mb-4">
                            <div class="overflow-hidden h-2 flex rounded-full bg-stone-100 shadow-inner">
                                <div style="width:${Math.min(100, (spentForCat / (allocated || 1)) * 100)}%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center ${remainingItemBalance < 0 ? 'bg-red-400' : 'bg-[#D4A373]'} transition-all duration-500"></div>
                            </div>
                        </div>
                        
                        <div class="flex gap-1.5 mt-auto">
                            <input type="number" id="spend-amt-${index}" placeholder="è¼¸å…¥é‡‘é¡" class="w-[45%] text-xs border border-stone-200 rounded p-1.5 outline-none focus:border-[#D4A373] focus:ring-1 focus:ring-[#D4A373] transition">
                            <select id="spend-method-${index}" class="w-[30%] text-[11px] font-bold text-stone-600 border border-stone-200 rounded p-1.5 outline-none bg-white focus:border-[#D4A373] transition">
                                <option value="cash">ğŸ’µ ç¾é‡‘</option>
                                <option value="credit">ğŸ’³ åˆ·å¡</option>
                            </select>
                            <button onclick="app.addTransaction(${index})" class="w-[25%] text-xs bg-[#D4A373] hover:bg-[#C39262] text-white rounded p-1.5 transition shadow-sm font-bold tracking-wider">è¨˜å¸³</button>
                        </div>
                    `;
                    listContainer.appendChild(div);
                });
            },

            // --- GOAL TRACKING RENDERER (With Delta Logic) ---
            renderGoals(type, poolAmount) {
                const listContainer = document.getElementById(`${type}List`);
                const goals = type === 'presave' ? this.data.presaveGoals : this.data.savingsGoals;
                const themeColor = type === 'presave' ? '#A3B18A' : '#E63946';
                const hoverColor = type === 'presave' ? 'hover:border-[#A3B18A]' : 'hover:border-[#E63946]';
                
                let totalAllocated = this._getSum(goals, 'budget');
                this._updateTabBadge(`${type}UnallocatedBadge`, poolAmount - totalAllocated);

                listContainer.innerHTML = '';

                if (goals.length === 0) {
                    listContainer.innerHTML = `<div class="text-center py-8 text-stone-400 text-sm border-2 border-dashed border-stone-200 rounded-xl">å°šç„¡è¨­å®šç›®æ¨™ï¼Œè«‹é»æ“Šå³ä¸Šæ–¹æ–°å¢ã€‚</div>`;
                    return;
                }

                goals.forEach((goal, index) => {
                    let target = goal.target || 0;
                    let accumulated = goal.accumulated || 0;
                    let thisMonthBudget = goal.budget || 0;
                    let ratio = goal.ratio !== undefined ? goal.ratio : 10;
                    
                    let currentTotal = accumulated + thisMonthBudget;
                    let progress = target > 0 ? Math.min(100, (currentTotal / target) * 100) : 0;
                    let isCompleted = currentTotal >= target && target > 0;

                    const div = document.createElement('div');
                    div.className = `p-5 bg-white border border-stone-200 rounded-xl shadow-sm transition-all ${hoverColor} relative group flex flex-col`;
                    
                    div.innerHTML = `
                        <button onclick="app.removeGoal('${type}', ${index})" class="absolute top-3 right-3 text-stone-300 hover:text-red-500 font-bold opacity-0 group-hover:opacity-100 transition text-xl">&times;</button>
                        
                        <div class="flex justify-between items-start mb-3">
                            <div class="w-10/12">
                                <input type="text" value="${goal.name}" 
                                    onchange="app.updateGoalName('${type}', ${index}, this.value)" 
                                    class="font-bold text-stone-700 text-lg bg-transparent border-b border-transparent focus:border-[${themeColor}] focus:outline-none w-full transition-colors" 
                                    placeholder="ç›®æ¨™åç¨± (ä¾‹å¦‚ï¼šæ—¥æœ¬æ—…éŠ)">
                                <div class="flex items-center text-[10px] text-stone-400 mt-1 gap-1">
                                    <span>è‡ªå‹•åˆ†é…æ¬Šé‡:</span>
                                    <input type="number" value="${ratio}" onchange="app.updateItemField('${type}', ${index}, 'ratio', this.value)" class="w-10 border-b border-stone-200 text-center focus:outline-none focus:border-[${themeColor}]">
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                            <div class="bg-stone-50 px-3 py-2 rounded-lg border border-stone-100 focus-within:border-[${themeColor}] transition-colors">
                                <label class="text-[10px] text-stone-400 block font-bold">ç›®æ¨™é‡‘é¡</label>
                                <div class="flex items-center text-stone-700 font-bold mt-1">
                                    $ <input type="number" value="${target}" onchange="app.updateItemField('${type}', ${index}, 'target', this.value)" class="w-full bg-transparent focus:outline-none ml-1 text-sm">
                                </div>
                            </div>
                            <div class="bg-stone-50 px-3 py-2 rounded-lg border border-stone-100 focus-within:border-[#D4A373] transition-colors" title="ä¿®æ”¹æ­¤æ¬„ä½å°‡å½±éŸ¿æœªåˆ†é…çµé¤˜æ°´åº«">
                                <label class="text-[10px] text-stone-400 block font-bold text-[#D4A373]">å·²ç´¯ç© (å¯ä¿®æ”¹)</label>
                                <div class="flex items-center text-stone-700 font-bold mt-1">
                                    $ <input type="number" value="${accumulated}" onchange="app.handleGoalFund('${type}', ${index}, this.value, ${accumulated})" class="w-full bg-transparent focus:outline-none ml-1 text-sm">
                                </div>
                            </div>
                            <div class="bg-[${themeColor}] bg-opacity-10 px-3 py-2 rounded-lg border border-[${themeColor}] border-opacity-30 focus-within:border-opacity-100 transition-colors">
                                <label class="text-[10px] text-[${themeColor}] block font-bold">æœ¬æœˆåˆ†é… (æœƒè½‰å…¥ç´¯ç©)</label>
                                <div class="flex items-center text-stone-700 font-bold mt-1">
                                    + <input type="number" value="${thisMonthBudget}" onchange="app.updateItemField('${type}', ${index}, 'budget', this.value)" class="w-full bg-transparent focus:outline-none ml-1 text-sm text-[${themeColor}]">
                                </div>
                            </div>
                            <div class="bg-stone-50 px-3 py-2 rounded-lg border border-stone-100 flex flex-col justify-center items-end">
                                <label class="text-[10px] text-stone-400 block font-bold">åŠ ç¸½é€²åº¦</label>
                                <div class="text-lg font-black text-stone-700 mt-0.5">${this.formatMoney(currentTotal)}</div>
                            </div>
                        </div>
                        
                        <div class="relative pt-1">
                            <div class="overflow-hidden h-3 flex rounded-full bg-stone-100 shadow-inner">
                                <div style="width:${progress}%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-[${themeColor}] transition-all duration-700 ${isCompleted ? 'animate-pulse' : ''}"></div>
                            </div>
                            <div class="text-right mt-1.5 text-xs font-bold ${isCompleted ? `text-[${themeColor}]` : 'text-stone-400'}">
                                é€²åº¦: ${progress.toFixed(1)}% ${isCompleted ? 'ğŸ‰ æ­å–œé”æ¨™ï¼' : ''}
                            </div>
                        </div>
                    `;
                    listContainer.appendChild(div);
                });
            },

            updateGoalName(type, index, value) {
                const goals = type === 'presave' ? this.data.presaveGoals : this.data.savingsGoals;
                goals[index].name = value || 'æœªå‘½åç›®æ¨™';
                this.calculateAndSave();
            },

            removeGoal(type, index) {
                this.showDialog('åˆªé™¤ç›®æ¨™', 'ç¢ºå®šè¦åˆªé™¤é€™å€‹ç›®æ¨™å—ï¼Ÿ\næ³¨æ„ï¼šæ­¤ç›®æ¨™å…§ã€Œå·²ç´¯ç©ã€çš„é‡‘é¡ä¸æœƒè‡ªå‹•é€€å›æ°´åº«ã€‚å¦‚æœæ‚¨å¸Œæœ›é€€å›ï¼Œè«‹å…ˆå°‡ã€Œå·²ç´¯ç©ã€ä¿®æ”¹ç‚º 0 å¾Œå†åˆªé™¤ã€‚', 'confirm', () => {
                    const goals = type === 'presave' ? this.data.presaveGoals : this.data.savingsGoals;
                    goals.splice(index, 1);
                    this.calculateAndSave();
                });
            },

            // --- Transactions ---
            addTransaction(index) {
                const item = this.data.budgetItems[index];
                const amtInput = document.getElementById(`spend-amt-${index}`);
                const methodSelect = document.getElementById(`spend-method-${index}`);
                
                const amount = Number(amtInput.value);
                if (amount > 0) {
                    const tx = {
                        id: Date.now(),
                        catId: item.id,
                        catName: item.name,
                        amount: amount,
                        method: methodSelect.value, 
                        date: new Date().toLocaleDateString('zh-TW', { month: 'numeric', day: 'numeric', hour: '2-digit', minute:'2-digit' })
                    };
                    this.data.transactions.push(tx);
                    this.calculateAndSave(); 
                    amtInput.value = '';
                }
            },

            renderTransactions() {
                const container = document.getElementById('txList');
                if (this.data.transactions.length === 0) {
                    container.innerHTML = `<div class="text-stone-400 text-xs italic text-center py-6 flex flex-col items-center gap-2"><span class="text-2xl">ğŸ“</span>å°šç„¡æ”¯å‡ºç´€éŒ„</div>`;
                    return;
                }
                container.innerHTML = '';
                const sortedTx = [...this.data.transactions].sort((a,b) => b.id - a.id);

                sortedTx.forEach(tx => {
                    const methodIcon = tx.method === 'credit' ? 'ğŸ’³' : 'ğŸ’µ';
                    const methodText = tx.method === 'credit' ? 'åˆ·å¡' : 'ç¾é‡‘';
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center py-2 border-b border-stone-100 last:border-0 hover:bg-stone-100 px-2 -mx-2 rounded transition-colors group';
                    div.innerHTML = `
                        <div>
                            <div class="text-[10px] text-stone-400">${tx.date}</div>
                            <div class="font-medium text-stone-700">${tx.catName}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-stone-800">${this.formatMoney(tx.amount)}</div>
                            <div class="text-[10px] text-stone-500 flex items-center justify-end gap-2 mt-0.5">
                                <span class="bg-stone-200 px-1 rounded">${methodIcon} ${methodText}</span>
                                <div class="opacity-0 group-hover:opacity-100 transition-opacity flex gap-2 ml-1">
                                    <button onclick="app.openEditModal(${tx.id})" class="text-blue-500 hover:text-blue-700 font-bold">ç·¨è¼¯</button>
                                    <button onclick="app.deleteTransaction(${tx.id})" class="text-red-500 hover:text-red-700 font-bold">åˆªé™¤</button>
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                });
            },

            deleteTransaction(id) {
                this.showDialog('ğŸ—‘ï¸ åˆªé™¤ç´€éŒ„', 'ç¢ºå®šè¦åˆªé™¤é€™ç­†æ”¯å‡ºç´€éŒ„å—ï¼Ÿ\nåˆªé™¤å¾Œè©²é¡åˆ¥çš„é ç®—é¤˜é¡å°‡æœƒè‡ªå‹•æ¢å¾©ã€‚', 'confirm', () => {
                    this.data.transactions = this.data.transactions.filter(tx => tx.id !== id);
                    this.calculateAndSave();
                });
            },
            openEditModal(id) {
                const tx = this.data.transactions.find(t => t.id === id);
                if (!tx) return;
                document.getElementById('editTxId').value = tx.id;
                document.getElementById('editTxAmount').value = tx.amount;
                document.getElementById('editTxMethod').value = tx.method;
                document.getElementById('editModal').classList.remove('hidden');
            },
            closeEditModal() { document.getElementById('editModal').classList.add('hidden'); },
            saveEditTx() {
                const id = Number(document.getElementById('editTxId').value);
                const newAmount = Number(document.getElementById('editTxAmount').value);
                const newMethod = document.getElementById('editTxMethod').value;
                if (newAmount > 0) {
                    const txIndex = this.data.transactions.findIndex(t => t.id === id);
                    if (txIndex !== -1) {
                        this.data.transactions[txIndex].amount = newAmount;
                        this.data.transactions[txIndex].method = newMethod;
                        this.closeEditModal();
                        this.calculateAndSave();
                    }
                }
            },

            // --- Credit Card Logic ---
            calculateCC_And_Balance(totalBudgetAmt) {
                const totalCreditSpend = this.data.transactions
                    .filter(tx => tx.method === 'credit')
                    .reduce((sum, tx) => sum + tx.amount, 0);
                
                let currentPouch = Math.max(0, totalCreditSpend - (this.data.ccPaidAmount || 0));
                document.getElementById('ccPouchTotal').textContent = this.formatMoney(currentPouch);

                const totalSpent = this.data.transactions.reduce((sum, tx) => sum + tx.amount, 0);
                const balance = Math.max(0, totalBudgetAmt - totalSpent);
                document.getElementById('monthEndBalance').textContent = this.formatMoney(balance);
            },

            clearCCPouch() {
                const totalCreditSpend = this.data.transactions
                    .filter(tx => tx.method === 'credit')
                    .reduce((sum, tx) => sum + tx.amount, 0);
                let currentPouch = Math.max(0, totalCreditSpend - (this.data.ccPaidAmount || 0));

                if(currentPouch <= 0) {
                    this.showDialog('æç¤º', 'ç›®å‰å¡è²»æ”¶ç´è¢‹å·²ç¶“æ˜¯ 0 å…ƒï¼Œä¸éœ€æ¸…ç©ºï¼', 'alert');
                    return;
                }

                this.showDialog('âœ… ç¹³æ¸…å¡è²»', `ç¢ºå®šæ‚¨å·²ç¶“å°‡æ”¶ç´è¢‹è£¡çš„ç¾é‡‘æ‹¿å»ç¹³äº¤ä¿¡ç”¨å¡è²»äº†å—ï¼Ÿ\n\nåŸ·è¡Œå¾Œï¼Œå¡è²»è¢‹é‡‘é¡å°‡æœƒæ­¸é›¶ï¼Œä½†æ‚¨çš„ã€Œæ­·å²æ”¯å‡ºæ˜ç´°ã€ä»æœƒä¿ç•™ä»¥ä¾›æŸ¥é–±ã€‚`, 'confirm', () => {
                    this.data.ccPaidAmount = (this.data.ccPaidAmount || 0) + currentPouch;
                    this.calculateAndSave();
                });
            },

            // --- Monthly Reset & History ---
            calculateResetPreview() {
                let { budget: budgetPool, presave: presaveAmt, savings: savingsAmt } = this.currentPools;
                
                let totalSpent = this.data.transactions.reduce((sum, tx) => sum + tx.amount, 0);
                let budgetBalance = Math.max(0, budgetPool - totalSpent);
                
                let presaveAllocated = this._getSum(this.data.presaveGoals, 'budget');
                let presaveBalance = Math.max(0, presaveAmt - presaveAllocated);
                
                let savingsAllocated = this._getSum(this.data.savingsGoals, 'budget');
                let savingsBalance = Math.max(0, savingsAmt - savingsAllocated);

                // Add up all unspent budget + unallocated amounts in presave and savings
                let totalToReservoir = budgetBalance + presaveBalance + savingsBalance;
                
                document.getElementById('monthEndBalance').textContent = this.formatMoney(totalToReservoir);
                document.getElementById('expectedReservoir').textContent = this.formatMoney((this.data.unallocatedSavings || 0) + totalToReservoir);
                
                this.resetStats = { budgetPool, totalSpent, totalToReservoir };
            },

            resetMonth() {
                let { budgetPool, totalSpent, totalToReservoir } = this.resetStats;

                this.showDialog('ğŸ—“ï¸ æœˆæœ«çµç®—ç¢ºèª', `å³å°‡åŸ·è¡Œæœˆçµç®—ï¼Œç³»çµ±æœƒåŸ·è¡Œä»¥ä¸‹å‹•ä½œï¼š\n\n1. å°‡æ‰€æœ‰ç›®æ¨™ä¸­çš„ã€Œæœ¬æœˆåˆ†é…ã€æ­£å¼å¯«å…¥ã€Œå·²ç´¯ç©ã€ä¸­ã€‚\n2. å°‡æ‰€æœ‰æœªä½¿ç”¨çš„é¡åº¦å…± <strong class="text-[#D4A373] text-lg">${this.formatMoney(totalToReservoir)}</strong> åŒ¯å…¥æ‚¨çš„ã€Œæœªåˆ†é…çµé¤˜æ°´åº«ã€ã€‚\n3. å°‡æœ¬æœˆè¨˜å¸³æ˜ç´° <strong class="text-stone-800">æ°¸ä¹…å°å­˜åˆ°æ­·å²ç´€éŒ„</strong>ã€‚\n4. æ¸…ç©ºç•¶æœˆå¸³æœ¬èˆ‡æœ¬æœˆåˆ†é…é¡ã€‚\n\nç¢ºèªåŸ·è¡Œçµç®—å—ï¼Ÿ`, 'confirm', () => {
                    
                    const now = new Date();
                    const monthStr = `${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆ`;
                    
                    let totalIncome = this.data.incomes.reduce((sum, item) => sum + (item.amount || 0), 0);
                    let totalFixed = this.data.fixedExpenses.reduce((a,b)=>a+(b.amount||0),0);
                    let totalDebt = this.data.hasDebt ? this.data.debts.reduce((a,b)=>a+(b.monthly||0),0) : 0;

                    const historyPayload = {
                        timestamp: Date.now(),
                        monthLabel: monthStr,
                        income: totalIncome,
                        fixed: totalFixed,
                        debt: totalDebt,
                        budgetPool: budgetPool,
                        spent: totalSpent,
                        savedThisMonth: totalToReservoir,
                        transactions: [...this.data.transactions]
                    };

                    if (window.saveHistoryToCloud) {
                        window.saveHistoryToCloud(historyPayload);
                    }

                    // Move budget to accumulated
                    this.data.presaveGoals.forEach(g => { g.accumulated += (g.budget || 0); g.budget = 0; });
                    this.data.savingsGoals.forEach(g => { g.accumulated += (g.budget || 0); g.budget = 0; });

                    // Update Unallocated Savings (Reservoir)
                    this.data.unallocatedSavings = (this.data.unallocatedSavings || 0) + totalToReservoir;
                    
                    // Reset Flags
                    this.data.isManualPresave = false;
                    this.data.isManualSavings = false;

                    // Clear Month Data
                    this.data.transactions = [];
                    this.data.ccPaidAmount = 0; 
                    
                    this.calculateAndSave();
                    
                    setTimeout(() => {
                        this.showDialog('ğŸ‰ çµç®—å®Œæˆ', `çµç®—æˆåŠŸï¼\nç›®æ¨™é€²åº¦å·²æ¨é€²ï¼Œä¸”å·²å°‡ ${this.formatMoney(totalToReservoir)} å­˜å…¥æ‚¨çš„çµé¤˜æ°´åº«ã€‚\n\nä¸‹å€‹æœˆçš„è–ªè³‡å·²æº–å‚™å¥½é‡æ–°åˆ†é…ï¼Œç¹¼çºŒæœç›®æ¨™é‚é€²å§ï¼`, 'alert', () => {
                            this.switchTab('savings'); 
                        });
                    }, 300);
                });
            },

            openHistoryModal() {
                document.getElementById('historyModal').classList.remove('hidden');
                this.renderHistoryList();
            },
            closeHistoryModal() {
                document.getElementById('historyModal').classList.add('hidden');
            },
            renderHistoryList() {
                const container = document.getElementById('historyListContainer');
                if (this.historyRecords.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-stone-400 py-16 flex flex-col items-center">
                            <span class="text-5xl mb-4">ğŸ“­</span>
                            <p class="font-bold text-lg text-stone-500">å°šç„¡æ­·å²ç´€éŒ„</p>
                            <p class="text-sm mt-2">è«‹åœ¨æœˆåº•é»æ“Šæœ€ä¸‹æ–¹çš„ã€ŒåŸ·è¡Œæœˆçµç®—ã€æŒ‰éˆ•ï¼Œ<br>ç³»çµ±å°±æœƒå°‡ç•¶æœˆç´€éŒ„å°å­˜åˆ°é€™è£¡å–”ï¼</p>
                        </div>`;
                    return;
                }

                container.innerHTML = '';
                const sorted = [...this.historyRecords].sort((a,b) => b.timestamp - a.timestamp);

                sorted.forEach((record, index) => {
                    const card = document.createElement('div');
                    card.className = 'mb-4 bg-white border border-stone-200 rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow';
                    
                    const header = document.createElement('div');
                    header.className = 'p-5 flex justify-between items-center cursor-pointer hover:bg-stone-50 transition group';
                    header.onclick = () => {
                        const detail = document.getElementById(`hist-detail-${index}`);
                        const icon = document.getElementById(`hist-icon-${index}`);
                        detail.classList.toggle('hidden');
                        icon.style.transform = detail.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
                    };
                    header.innerHTML = `
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full bg-stone-100 flex items-center justify-center text-xl shadow-inner">ğŸ“…</div>
                            <div>
                                <h4 class="font-bold text-stone-800 text-lg group-hover:text-[#D4A373] transition-colors">${record.monthLabel}</h4>
                                <div class="text-xs text-stone-500 mt-0.5 font-medium">
                                    ç¸½æ”¶å…¥: ${this.formatMoney(record.income)} <span class="mx-1">|</span> ç¸½æ”¯å‡º: ${this.formatMoney(record.spent)}
                                </div>
                            </div>
                        </div>
                        <div class="text-right flex items-center gap-4">
                            <div>
                                <div class="text-[10px] text-green-600 font-bold mb-0.5 uppercase tracking-wide">çµé¤˜åŒ¯å…¥æ°´åº«</div>
                                <div class="text-xl font-bold text-green-600 bg-green-50 px-3 py-1 rounded-lg">+${this.formatMoney(record.savedThisMonth)}</div>
                            </div>
                            <div id="hist-icon-${index}" class="text-stone-400 transition-transform duration-300">â–¼</div>
                        </div>
                    `;

                    const details = document.createElement('div');
                    details.id = `hist-detail-${index}`;
                    details.className = 'hidden bg-white p-5 border-t border-stone-100';
                    
                    let txHtml = '';
                    if (record.transactions && record.transactions.length > 0) {
                        txHtml = `<div class="space-y-2 mt-3">`;
                        record.transactions.forEach(tx => {
                            const mIcon = tx.method === 'credit' ? 'ğŸ’³' : 'ğŸ’µ';
                            const mText = tx.method === 'credit' ? 'åˆ·å¡' : 'ç¾é‡‘';
                            txHtml += `
                            <div class="flex justify-between items-center text-sm py-2 px-3 bg-stone-50 rounded-lg border border-stone-100">
                                <div class="flex items-center gap-2">
                                    <span class="text-stone-700 font-medium">${tx.catName}</span> 
                                    <span class="text-[10px] text-stone-500 bg-stone-200 px-1.5 py-0.5 rounded font-bold">${mIcon} ${mText}</span>
                                </div>
                                <span class="font-bold text-stone-800">${this.formatMoney(tx.amount)}</span>
                            </div>`;
                        });
                        txHtml += `</div>`;
                    } else {
                        txHtml = `<div class="text-sm text-stone-400 italic mt-3 bg-stone-50 p-4 rounded-lg text-center">æœ¬æœˆç„¡ä»»ä½•æ”¯å‡ºæ˜ç´°</div>`;
                    }

                    details.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm mb-6">
                            <div class="bg-stone-50 p-3 rounded-lg border border-stone-100">
                                <div class="text-xs text-stone-400 mb-1">å›ºå®šæ”¯å‡ºç¸½è¨ˆ</div>
                                <div class="font-bold text-stone-700">${this.formatMoney(record.fixed)}</div>
                            </div>
                            <div class="bg-stone-50 p-3 rounded-lg border border-stone-100">
                                <div class="text-xs text-stone-400 mb-1">è² å‚µæœˆç¹³ç¸½è¨ˆ</div>
                                <div class="font-bold text-stone-700">${this.formatMoney(record.debt)}</div>
                            </div>
                            <div class="bg-stone-50 p-3 rounded-lg border border-stone-100">
                                <div class="text-xs text-stone-400 mb-1">ç”Ÿæ´»è²»é ç®—æ± </div>
                                <div class="font-bold text-[#D4A373]">${this.formatMoney(record.budgetPool)}</div>
                            </div>
                        </div>
                        <h5 class="font-bold text-stone-700 text-sm flex items-center gap-2 mb-2"><span class="text-lg">ğŸ“‹</span> å”¯è®€æ”¯å‡ºæ˜ç´°</h5>
                        ${txHtml}
                    `;

                    card.appendChild(header);
                    card.appendChild(details);
                    container.appendChild(card);
                });
            },

            // --- List Management ---
            renderIncomeList() {
                const container = document.getElementById('incomeList');
                container.innerHTML = '';
                this.data.incomes.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'flex gap-2 items-center';
                    div.innerHTML = `
                        <input type="text" value="${item.name}" onchange="app.updateIncome(${index}, 'name', this.value)" class="flex-1 input-std text-sm py-1.5" placeholder="é …ç›®å">
                        <input type="number" value="${item.amount || ''}" onchange="app.updateIncome(${index}, 'amount', this.value)" class="w-24 input-std text-sm py-1.5" placeholder="é‡‘é¡">
                        <button onclick="app.removeIncome(${index})" class="text-stone-300 hover:text-red-500 font-bold px-1 text-lg leading-none transition">&times;</button>
                    `;
                    container.appendChild(div);
                });
            },
            renderFixedList() {
                const container = document.getElementById('fixedList');
                container.innerHTML = '';
                this.data.fixedExpenses.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'flex gap-2 items-center';
                    div.innerHTML = `
                        <input type="text" value="${item.name}" onchange="app.updateFixed(${index}, 'name', this.value)" class="flex-1 input-std text-sm py-1.5" placeholder="é …ç›®å">
                        <input type="number" value="${item.amount || ''}" onchange="app.updateFixed(${index}, 'amount', this.value)" class="w-24 input-std text-sm py-1.5" placeholder="é‡‘é¡">
                        <button onclick="app.removeFixed(${index})" class="text-stone-300 hover:text-red-500 font-bold px-1 text-lg leading-none transition">&times;</button>
                    `;
                    container.appendChild(div);
                });
            },
            renderDebtList() {
                const container = document.getElementById('debtList');
                container.innerHTML = '';
                this.data.debts.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'bg-red-50 p-4 rounded-xl border border-red-100 mb-3 relative shadow-sm';
                    div.innerHTML = `
                        <div class="flex justify-between items-center mb-4">
                            <input type="text" value="${item.name}" onchange="app.updateDebt(${index}, 'name', this.value)" class="bg-transparent border-b border-transparent hover:border-red-200 w-2/3 focus:outline-none focus:border-red-400 font-bold text-stone-800 text-lg transition-colors" placeholder="ä¾‹å¦‚ï¼šå­¸è²¸ã€ä¿¡è²¸">
                            <button onclick="app.removeDebt(${index})" class="text-red-400 hover:text-red-600 hover:bg-red-100 text-sm px-3 py-1.5 rounded-lg transition font-bold">åˆªé™¤</button>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <label class="text-xs text-stone-500 font-bold block mb-1">æ¯æœˆæ‡‰ç¹³</label>
                                <input type="number" value="${item.monthly || ''}" onchange="app.updateDebt(${index}, 'monthly', this.value)" class="w-full bg-white border border-red-100 rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-red-300 transition">
                            </div>
                            <div>
                                <label class="text-xs text-stone-500 font-bold block mb-1">å‰©é¤˜æœ¬é‡‘</label>
                                <input type="number" value="${item.principal || ''}" onchange="app.updateDebt(${index}, 'principal', this.value)" class="w-full bg-white border border-red-100 rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-red-300 transition">
                            </div>
                            <div>
                                <label class="text-xs text-stone-500 font-bold block mb-1">åˆ©ç‡ (%)</label>
                                <input type="number" step="0.01" value="${item.rate || ''}" onchange="app.updateDebt(${index}, 'rate', this.value)" class="w-full bg-white border border-red-100 rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-red-300 transition">
                            </div>
                            <div>
                                <label class="text-xs text-stone-500 font-bold block mb-1">å‰©é¤˜æœŸæ•¸ (æœˆ)</label>
                                <input type="number" value="${item.terms || ''}" onchange="app.updateDebt(${index}, 'terms', this.value)" class="w-full bg-white border border-red-100 rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-red-300 transition">
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                });
            },
            addItem(type) {
                if (type === 'income') {
                    this.data.incomes.push({ id: 'inc-'+Date.now(), name: 'æ–°æ”¶å…¥é …ç›®', amount: 0 });
                    this.renderIncomeList();
                    this.calculateAndSave();
                } else if (type === 'fixed') {
                    this.data.fixedExpenses.push({ name: '', amount: 0 });
                    this.renderFixedList();
                } else if (type === 'debt') {
                    this.data.debts.push({ name: 'æ–°å‚µå‹™', principal: 0, rate: 0, monthly: 0, terms: 0 });
                    this.renderDebtList();
                    this.calculateAndSave();
                } else if (type === 'budget') {
                    this.data.isManualBudget = true; 
                    this.data.budgetItems.push({ id: 'cat-'+Date.now(), name: 'æ–°é¡åˆ¥', budget: 0, ratio: 10 });
                    this.calculateAndSave();
                } else if (type === 'presave') {
                    this.data.presaveGoals.push({ id: 'ps-'+Date.now(), name: 'æ–°é¡˜æœ›', target: 0, accumulated: 0, budget: 0, ratio: 10 });
                    this.calculateAndSave();
                } else if (type === 'savings') {
                    this.data.savingsGoals.push({ id: 'sv-'+Date.now(), name: 'æ–°ç›®æ¨™', target: 0, accumulated: 0, budget: 0, ratio: 10 });
                    this.calculateAndSave();
                }
            },
            updateIncome(index, field, value) {
                this.data.incomes[index][field] = field === 'amount' ? Number(value) : value;
                this.calculateAndSave();
            },
            removeIncome(index) {
                this.showDialog('åˆªé™¤æ”¶å…¥', 'ç¢ºå®šè¦åˆªé™¤é€™ç­†æ”¶å…¥é …ç›®å—ï¼Ÿ', 'confirm', () => {
                    this.data.incomes.splice(index, 1);
                    this.renderIncomeList();
                    this.calculateAndSave();
                });
            },
            updateBudgetItemName(index, newName) {
                const validName = newName.trim() === '' ? 'æœªå‘½åé¡åˆ¥' : newName.trim();
                const catId = this.data.budgetItems[index].id;
                this.data.budgetItems[index].name = validName;
                this.data.transactions.forEach(tx => { if (tx.catId === catId) tx.catName = validName; });
                this.calculateAndSave(); 
            },
            updateFixed(index, field, value) {
                this.data.fixedExpenses[index][field] = field === 'amount' ? Number(value) : value;
                this.calculateAndSave();
            },
            removeFixed(index) {
                this.data.fixedExpenses.splice(index, 1);
                this.renderFixedList();
                this.calculateAndSave();
            },
            updateDebt(index, field, value) {
                this.data.debts[index][field] = field === 'name' ? value : Number(value);
                this.calculateAndSave();
            },
            removeDebt(index) {
                this.showDialog('åˆªé™¤å‚µå‹™', 'ç¢ºå®šè¦åˆªé™¤é€™ç­†å‚µå‹™å—ï¼Ÿ', 'confirm', () => {
                    this.data.debts.splice(index, 1);
                    this.renderDebtList();
                    this.calculateAndSave();
                });
            },
            removeBudgetItem(index) {
                this.showDialog('åˆªé™¤é ç®—é¡åˆ¥', 'ç¢ºå®šè¦åˆªé™¤é€™å€‹é ç®—é¡åˆ¥å—ï¼Ÿ\næ­¤æ“ä½œå°‡æœƒä¸€ä½µåˆªé™¤è©²é¡åˆ¥ä¸‹çš„æ‰€æœ‰ç•¶æœˆè¨˜å¸³ç´€éŒ„ï¼', 'confirm', () => {
                    const idToRemove = this.data.budgetItems[index].id;
                    this.data.budgetItems.splice(index, 1);
                    this.data.transactions = this.data.transactions.filter(tx => tx.catId !== idToRemove);
                    this.data.isManualBudget = true; 
                    this.calculateAndSave();
                });
            },
            toggleDebtSection() {
                this.data.hasDebt = !this.data.hasDebt;
                const container = document.getElementById('debtContainer');
                const btn = document.getElementById('debtToggleBtn');
                const msg = document.getElementById('noDebtMessage');
                if (this.data.hasDebt) {
                    container.classList.remove('hidden');
                    msg.classList.add('hidden');
                    btn.textContent = "åˆ‡æ›ç‚ºç„¡è² å‚µ";
                    btn.classList.add('bg-red-100', 'text-red-600', 'font-bold');
                    if(this.data.debts.length === 0) this.addItem('debt');
                } else {
                    container.classList.add('hidden');
                    msg.classList.remove('hidden');
                    btn.textContent = "æˆ‘æœ‰è² å‚µ";
                    btn.classList.remove('bg-red-100', 'text-red-600', 'font-bold');
                }
                this.calculateAndSave();
            },
            formatMoney(num) {
                return new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(num);
            }
        };

        // Initialize immediately
        window.addEventListener('DOMContentLoaded', () => {
            window.app.init();
        });
    </script>

    <!-- FIREBASE MODULE -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        let firebaseConfig = null;
        try { if (typeof __firebase_config !== 'undefined') firebaseConfig = JSON.parse(__firebase_config); } catch(e) {}
        
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'smart-budget-app';
        const loadingOverlay = document.getElementById('loadingOverlay');
        
        if (firebaseConfig) {
            try {
                const firebaseApp = initializeApp(firebaseConfig);
                window.auth = getAuth(firebaseApp);
                window.db = getFirestore(firebaseApp);

                window.saveStateToCloud = (data) => {
                    if (window.db && window.user) {
                        const stateRef = doc(window.db, 'artifacts', window.appId, 'users', window.user.uid, 'appData', 'state');
                        setDoc(stateRef, data).catch(e => console.error(e));
                    }
                };

                window.saveHistoryToCloud = async (historyPayload) => {
                    if (window.db && window.user) {
                        const historyRef = doc(window.db, 'artifacts', window.appId, 'users', window.user.uid, 'history', Date.now().toString());
                        await setDoc(historyRef, historyPayload);
                    }
                };

                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(window.auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(window.auth);
                    }
                };

                initAuth().then(() => {
                    onAuthStateChanged(window.auth, async (u) => {
                        window.user = u;
                        if (u) {
                            try {
                                const stateRef = doc(window.db, 'artifacts', window.appId, 'users', u.uid, 'appData', 'state');
                                const snap = await getDoc(stateRef);
                                if (snap.exists()) {
                                    const cData = snap.data();
                                    
                                    // Handle state migrations
                                    if(cData.salary !== undefined || cData.bonus !== undefined) {
                                        if(!cData.incomes || cData.incomes.length === 0) {
                                            cData.incomes = [
                                                { id: 'inc-1', name: 'æœˆè–ªè³‡ (å¯¦é ˜)', amount: cData.salary || 0 },
                                                { id: 'inc-2', name: 'é¡å¤–çé‡‘/æ”¶å…¥', amount: cData.bonus || 0 }
                                            ];
                                        }
                                        delete cData.salary;
                                        delete cData.bonus;
                                    }
                                    if(!cData.incomes) cData.incomes = [{ id: 'inc-1', name: 'æœˆè–ªè³‡ (å¯¦é ˜)', amount: 0 }];
                                    if(cData.totalSavings && !cData.unallocatedSavings) cData.unallocatedSavings = cData.totalSavings;
                                    if(!cData.presaveGoals) cData.presaveGoals = window.app.data.presaveGoals;
                                    if(!cData.savingsGoals) cData.savingsGoals = window.app.data.savingsGoals;
                                    if(cData.ccPaidAmount === undefined) cData.ccPaidAmount = 0;
                                    if(!cData.masterRatios) cData.masterRatios = { budget: 50, presave: 20, savings: 30 };
                                    
                                    cData.presaveGoals.forEach(g => { 
                                        if(g.current !== undefined) { g.accumulated = g.current; delete g.current; }
                                    });
                                    cData.savingsGoals.forEach(g => { 
                                        if(g.current !== undefined) { g.accumulated = g.current; delete g.current; }
                                    });

                                    window.app.data = { ...window.app.data, ...cData };
                                    
                                    window.app.data.budgetItems.forEach(item => {
                                        if(item.ratio === undefined) { const dc = defaultBudget.find(c => c.name === item.name); item.ratio = dc ? dc.ratio : 10; }
                                        if(item.budget === undefined) item.budget = 0;
                                    });
                                    window.app.data.presaveGoals.forEach(item => {
                                        if(item.ratio === undefined) item.ratio = 10;
                                        if(item.budget === undefined) item.budget = 0;
                                    });
                                    window.app.data.savingsGoals.forEach(item => {
                                        if(item.ratio === undefined) item.ratio = 10;
                                        if(item.budget === undefined) item.budget = 0;
                                    });
                                }
                            } catch (err) { console.error("Fetch state err", err); }
                            
                            try {
                                const historyRef = collection(window.db, 'artifacts', window.appId, 'users', u.uid, 'history');
                                onSnapshot(historyRef, (snapshot) => {
                                    window.app.historyRecords = [];
                                    snapshot.forEach(doc => window.app.historyRecords.push({ id: doc.id, ...doc.data() }));
                                    if(!document.getElementById('historyModal').classList.contains('hidden')) {
                                        window.app.renderHistoryList();
                                    }
                                }, (err) => console.error("History listen error", err));
                            } catch (err) { console.error("Set history listener err", err); }
                            
                            loadingOverlay.classList.add('opacity-0');
                            setTimeout(() => loadingOverlay.classList.add('hidden'), 300);
                            window.app.init();
                        }
                    });
                }).catch(e => {
                    console.error("Auth err", e);
                    loadingOverlay.classList.add('opacity-0');
                    setTimeout(() => loadingOverlay.classList.add('hidden'), 300);
                });

            } catch(e) {
                console.error("Firebase init err", e);
                loadingOverlay.classList.add('opacity-0');
                setTimeout(() => loadingOverlay.classList.add('hidden'), 300);
            }
        } else {
            loadingOverlay.classList.add('opacity-0');
            setTimeout(() => loadingOverlay.classList.add('hidden'), 300);
        }
    </script>
</body>
</html>